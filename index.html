<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Retail Loan Management</title>
  <link rel="stylesheet" href="styles.css">
  <script defer src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script type="module" src="config.js"></script>
</head>
<body>
  <div id="app">
    <header>
      <h1>Retail Loan Management</h1>
      <button id="logoutButton">Logout</button>
    </header>
    <main>
      <div id="loginScreen" style="display: none;">
        <h2>Login</h2>
        <form id="loginForm">
          <input type="text" id="username" placeholder="Username" required />
          <input type="password" id="password" placeholder="Password" required />
          <button type="submit">Login</button>
        </form>
      </div>
      <div id="managerDashboard" style="display: none;">
        <h2>Manager Dashboard</h2>
        <form id="addCustomerForm">
          <h3>Add New Customer</h3>
          <input type="text" id="customerName" placeholder="Customer Name" required />
          <button type="submit">Add Customer</button>
        </form>
        <form id="addLoanForm">
          <h3>Add New Loan</h3>
          <select id="customerDropdown" required></select>
          <input type="number" id="loanAmount" placeholder="Loan Amount" required />
          <input type="number" id="interestRate" placeholder="Interest Rate (%)" required />
          <input type="number" id="duration" placeholder="Duration (days)" required />
          <button type="submit">Add Loan</button>
        </form>
        <h3>Collections</h3>
        <div id="collectionSection"></div>
      </div>
      <div id="adminDashboard" style="display: none;">
        <h2>Admin Dashboard</h2>
        <!-- Admin specific content goes here -->
      </div>
    </main>
  </div>
  <script type="module">
    import { config, getToken } from './config.js';

    const isProduction = window.location.hostname !== '127.0.0.1';
    const { gistId } = config;
    const apiUrl = `https://api.github.com/gists/${gistId}`;
    const localDataUrl = 'data.json';

    let appState = {
      customers: [],
      loans: [],
      collections: [],
      users: [], // Add users to the app state
    };

    async function fetchData() {
      try {
        const response = await fetch(isProduction ? apiUrl : localDataUrl, {
          headers: isProduction ? { Authorization: `token ${getToken()}` } : {},
        });
        const data = await response.json();
        appState = isProduction ? JSON.parse(data.files['data.json'].content) : data;
        populateCustomerDropdown();
        populateCollectionSection();
      } catch (error) {
        console.error('Error fetching data:', error);
        alert('Error fetching data. Please try again.');
      }
    }

    async function saveData() {
      try {
        const updatedContent = JSON.stringify(appState, null, 2);
        if (isProduction) {
          await fetch(apiUrl, {
            method: 'PATCH',
            headers: {
              Authorization: `token ${getToken()}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              files: {
                'data.json': {
                  content: updatedContent,
                },
              },
            }),
          });
        } else {
          // For local development, you might need to implement a local server to handle saving data
          console.log('Data to be saved locally:', updatedContent);
        }
        alert('Data saved successfully!');
      } catch (error) {
        console.error('Error saving data:', error);
        alert('Error saving data. Please try again.');
      }
    }

    function autoGenerateCustomerId() {
      return `CUST${Date.now()}`;
    }

    function autoGenerateLoanId() {
      return `LOAN${Date.now()}`;
    }

    function populateCustomerDropdown() {
      const customerDropdown = document.getElementById('customerDropdown');
      customerDropdown.innerHTML = '<option value="">Select Customer</option>';
      appState.customers.forEach((customer) => {
        const option = document.createElement('option');
        option.value = customer.id;
        option.textContent = customer.name;
        customerDropdown.appendChild(option);
      });
    }

    function populateCollectionSection() {
      const collectionSection = document.getElementById('collectionSection');
      collectionSection.innerHTML = '';
      appState.loans.forEach((loan) => {
        const loanDiv = document.createElement('div');
        loanDiv.textContent = `Loan ID: ${loan.id}, Customer: ${loan.customerId}, Amount: ${loan.loanAmount}`;
        const collectButton = document.createElement('button');
        collectButton.textContent = 'Collect';
        collectButton.addEventListener('click', () => handleCollect(loan.id));
        loanDiv.appendChild(collectButton);
        collectionSection.appendChild(loanDiv);
      });
    }

    function handleCollect(loanId) {
      const confirmed = confirm('Are you sure you want to collect for this loan?');
      if (confirmed) {
        const loan = appState.loans.find((l) => l.id === loanId);
        appState.collections.push({ loanId, date: new Date().toISOString() });
        saveData();
        alert(`Collection recorded for Loan ID: ${loanId}`);
      }
    }

    const addCustomerForm = document.getElementById('addCustomerForm');
    addCustomerForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const customerName = document.getElementById('customerName').value;
      const customerId = autoGenerateCustomerId();
      appState.customers.push({ id: customerId, name: customerName });
      await saveData();
      populateCustomerDropdown();
      alert('Customer added successfully!');
    });

    const addLoanForm = document.getElementById('addLoanForm');
    addLoanForm.addEventListener('submit', (event) => {
      event.preventDefault();
      const customerId = document.getElementById('customerDropdown').value;
      const loanAmount = parseFloat(document.getElementById('loanAmount').value);
      const interestRate = parseFloat(document.getElementById('interestRate').value);
      const duration = parseInt(document.getElementById('duration').value, 10);
      const loanId = autoGenerateLoanId();
      appState.loans.push({ id: loanId, customerId, loanAmount, interestRate, duration });
      saveData();
      populateCollectionSection();
      alert('Loan added successfully!');
    });

    document.getElementById('logoutButton').addEventListener('click', () => {
      // Clear app state and show login screen
      appState = {
        customers: [],
        loans: [],
        collections: [],
        users: appState.users, // Preserve users
      };
      alert('You have been logged out.');
      document.getElementById('managerDashboard').style.display = 'none';
      document.getElementById('adminDashboard').style.display = 'none';
      document.getElementById('loginScreen').style.display = 'block';
    });

    document.getElementById('loginForm').addEventListener('submit', async (event) => {
      event.preventDefault();
      // Perform login validation here
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      try {
        const response = await fetch(isProduction ? apiUrl : localDataUrl, {
          headers: isProduction ? { Authorization: `token ${getToken()}` } : {},
        });
        const data = await response.json();
        const users = isProduction ? JSON.parse(data.files['data.json'].content).users : data.users;
        const user = users.find((user) => user.username === username && user.password === password);
        if (user) {
          document.getElementById('loginScreen').style.display = 'none';
          if (user.type === 'admin') {
            document.getElementById('adminDashboard').style.display = 'block';
          } else if (user.type === 'manager') {
            document.getElementById('managerDashboard').style.display = 'block';
            fetchData();
          }
        } else {
          alert('Invalid credentials!');
        }
      } catch (error) {
        console.error('Error fetching users:', error);
        alert('Error during login. Please try again.');
      }
    });

    // Initially show login screen
    document.getElementById('managerDashboard').style.display = 'none';
    document.getElementById('adminDashboard').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'block';

    // Fetch initial data
    fetchData();
  </script>
</body>
</html>
