<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Retail Loan Management</title>
  <link rel="stylesheet" href="styles.css">
  <script defer src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script type="module" src="config.js"></script>
  <style>
    /* Add responsive table styles */
    .responsive-table {
      width: 100%;
      border-collapse: collapse;
    }
    .responsive-table th, .responsive-table td {
      border: 1px solid #ddd;
      padding: 8px;
    }
    .responsive-table th {
      background-color: #f2f2f2;
      text-align: left;
    }
    .responsive-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .responsive-table tr:hover {
      background-color: #ddd;
    }
    /* Toaster styles */
    .toaster {
      visibility: hidden;
      min-width: 250px;
      margin-left: -125px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 2px;
      padding: 16px;
      position: fixed;
      z-index: 1;
      left: 50%;
      bottom: 30px;
      font-size: 17px;
    }
    .toaster.show {
      visibility: visible;
      -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
      animation: fadein 0.5s, fadeout 0.5s 2.5s;
    }
    @-webkit-keyframes fadein {
      from {bottom: 0; opacity: 0;} 
      to {bottom: 30px; opacity: 1;}
    }
    @keyframes fadein {
      from {bottom: 0; opacity: 0;}
      to {bottom: 30px; opacity: 1;}
    }
    @-webkit-keyframes fadeout {
      from {bottom: 30px; opacity: 1;} 
      to {bottom: 0; opacity: 0;}
    }
    @keyframes fadeout {
      from {bottom: 30px; opacity: 1;}
      to {bottom: 0; opacity: 0;}
    }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h1>Retail Loan Management</h1>
      <nav>
        <button id="customersPageButton">Customers</button>
        <button id="loansPageButton">Loans</button>
        <button id="collectionsPageButton">Collections</button>
        <button id="logoutButton">Logout</button>
      </nav>
    </header>
    <main>
      <div id="loginScreen" style="display: none;">
        <h2>Login</h2>
        <form id="loginForm">
          <input type="text" id="username" placeholder="Username" required />
          <input type="password" id="password" placeholder="Password" required />
          <button type="submit">Login</button>
        </form>
      </div>
      <div id="customersPage" style="display: none;">
        <h2>Customers</h2>
        <form id="addCustomerForm">
          <h3>Add New Customer</h3>
          <input type="text" id="customerName" placeholder="Customer Name" required />
          <button type="submit">Add Customer</button>
        </form>
        <h3>Customer List</h3>
        <table class="responsive-table" id="customersTable">
          <thead>
            <tr>
              <th>Customer ID</th>
              <th>Customer Name</th>
            </tr>
          </thead>
          <tbody id="customersList"></tbody>
        </table>
      </div>
      <div id="loansPage" style="display: none;">
        <h2>Loans</h2>
        <form id="addLoanForm">
          <h3>Add New Loan</h3>
          <select id="customerDropdown" required></select>
          <input type="number" id="loanAmount" placeholder="Loan Amount" required />
          <input type="number" id="interestRate" placeholder="Interest Rate (%)" required />
          <input type="number" id="duration" placeholder="Duration (days)" required />
          <button type="submit">Add Loan</button>
        </form>
        <h3>Loan List</h3>
        <table class="responsive-table" id="loansTable">
          <thead>
            <tr>
              <th>Loan ID</th>
              <th>Customer ID</th>
              <th>Loan Amount</th>
              <th>Interest Rate</th>
              <th>Duration</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="loansList"></tbody>
        </table>
      </div>
      <div id="collectionsPage" style="display: none;">
        <h2>Collections</h2>
        <table class="responsive-table" id="collectionTable">
          <thead>
            <tr>
              <th>Customer Name</th>
              <th>Loan ID</th>
              <th>Start Date</th>
              <th>Collected Amount</th>
              <th>Count</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="collectionSection"></tbody>
        </table>
      </div>
      <div id="adminDashboard" style="display: none;">
        <h2>Admin Dashboard</h2>
        <!-- Admin specific content goes here -->
      </div>
    </main>
  </div>
  <div id="toaster" class="toaster"></div>
  <script type="module">
    import { config, getToken } from './config.js';

    const isProduction = window.location.hostname !== '127.0.0.1';
    const { gistId } = config;
    const apiUrl = `https://api.github.com/gists/${gistId}`;
    const localDataUrl = 'data.json';

    let appState = {
      customers: [],
      loans: [],
      collections: [],
      users: [], // Add users to the app state
    };

    function showToast(message) {
      const toaster = document.getElementById('toaster');
      toaster.textContent = message;
      toaster.className = "toaster show";
      setTimeout(() => { toaster.className = toaster.className.replace("show", ""); }, 3000);
    }

    async function fetchData() {
      try {
        const response = await fetch(isProduction ? apiUrl : localDataUrl, {
          headers: isProduction ? { Authorization: `token ${getToken()}` } : {},
        });
        const data = await response.json();
        appState = isProduction ? JSON.parse(data.files['data.json'].content) : data;
        populateCustomerDropdown();
        populateCustomersList();
        populateLoansList();
        populateCollectionSection();
      } catch (error) {
        console.error('Error fetching data:', error);
        showToast('Error fetching data. Please try again.');
      }
    }

    async function saveData() {
      try {
        const updatedContent = JSON.stringify(appState, null, 2);
        if (isProduction) {
          await fetch(apiUrl, {
            method: 'PATCH',
            headers: {
              Authorization: `token ${getToken()}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              files: {
                'data.json': {
                  content: updatedContent,
                },
              },
            }),
          });
        } else {
          // For local development, you might need to implement a local server to handle saving data
          console.log('Data to be saved locally:', updatedContent);
        }
        showToast('Data saved successfully!');
      } catch (error) {
        console.error('Error saving data:', error);
        showToast('Error saving data. Please try again.');
      }
    }

    function autoGenerateCustomerId() {
      return `CUST${Date.now()}`;
    }

    function autoGenerateLoanId() {
      return `LOAN${Date.now()}`;
    }

    function populateCustomerDropdown() {
      const customerDropdown = document.getElementById('customerDropdown');
      customerDropdown.innerHTML = '<option value="">Select Customer</option>';
      appState.customers.forEach((customer) => {
        const option = document.createElement('option');
        option.value = customer.id;
        option.textContent = customer.name;
        customerDropdown.appendChild(option);
      });
    }

    function populateCustomersList() {
      const customersList = document.getElementById('customersList');
      customersList.innerHTML = '';
      appState.customers.forEach((customer) => {
        const customerRow = document.createElement('tr');
        customerRow.innerHTML = `
          <td>${customer.id}</td>
          <td>${customer.name}</td>
        `;
        customersList.appendChild(customerRow);
      });
    }

    function populateLoansList() {
      const loansList = document.getElementById('loansList');
      loansList.innerHTML = '';
      appState.loans.forEach((loan) => {
        const loanRow = document.createElement('tr');
        loanRow.innerHTML = `
          <td>${loan.id}</td>
          <td>${loan.customerId}</td>
          <td>${loan.loanAmount}</td>
          <td>${loan.interestRate}</td>
          <td>${loan.duration}</td>
          <td>${loan.status}</td>
        `;
        loansList.appendChild(loanRow);
      });
    }

    function populateCollectionSection() {
      const collectionSection = document.getElementById('collectionSection');
      collectionSection.innerHTML = '';
      appState.loans.forEach((loan) => {
        const customer = appState.customers.find((c) => c.id === loan.customerId);
        const dailyAmount = loan.loanAmount / loan.duration;
        const dailyCollection = dailyAmount + (dailyAmount * loan.interestRate / 100);
        const collections = appState.collections.filter((collection) => collection.loanId === loan.id);
        const collectedAmount = collections.reduce((total, collection) => total + dailyCollection, 0);
        const isCollectDisabled = collections.length >= loan.duration;
        if (isCollectDisabled) {
          loan.status = 'completed';
        }
        const loanDiv = document.createElement('tr');
        loanDiv.innerHTML = `
          <td>${customer ? customer.name : 'Unknown'}</td>
          <td>${loan.id}</td>
          <td>${new Date(loan.startDate).toLocaleDateString()}</td>
          <td>${collectedAmount.toFixed(2)}</td>
          <td>${collections.length}</td>
          <td><button onclick="handleCollect('${loan.id}')" ${isCollectDisabled ? 'disabled' : ''}>Collect</button></td>
        `;
        collectionSection.appendChild(loanDiv);
      });
    }

    async function handleCollect(loanId) {
      const confirmed = confirm('Are you sure you want to collect for this loan?');
      if (confirmed) {
        const loan = appState.loans.find((l) => l.id === loanId);
        appState.collections.push({ loanId, date: new Date().toISOString() });
        await saveData();
        showToast(`Collection recorded for Loan ID: ${loanId}`);
        populateCollectionSection(); // Update the collection section
      }
    }

    // Make handleCollect globally accessible
    window.handleCollect = handleCollect;

    const addCustomerForm = document.getElementById('addCustomerForm');
    addCustomerForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const customerName = document.getElementById('customerName').value;
      const customerId = autoGenerateCustomerId();
      appState.customers.push({ id: customerId, name: customerName });
      await saveData();
      populateCustomerDropdown();
      populateCustomersList();
      showToast('Customer added successfully!');
    });

    const addLoanForm = document.getElementById('addLoanForm');
    addLoanForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const customerId = document.getElementById('customerDropdown').value;
      const loanAmount = parseFloat(document.getElementById('loanAmount').value);
      const interestRate = parseFloat(document.getElementById('interestRate').value);
      const duration = parseInt(document.getElementById('duration').value, 10);
      const loanId = autoGenerateLoanId();
      appState.loans.push({ id: loanId, customerId, loanAmount, interestRate, duration, startDate: new Date().toISOString(), status: 'active' });
      await saveData();
      populateLoansList();
      populateCollectionSection();
      showToast('Loan added successfully!');
    });

    document.getElementById('logoutButton').addEventListener('click', () => {
      // Clear app state and show login screen
      appState = {
        customers: [],
        loans: [],
        collections: [],
        users: appState.users, // Preserve users
      };
      showToast('You have been logged out.');
      document.getElementById('customersPage').style.display = 'none';
      document.getElementById('loansPage').style.display = 'none';
      document.getElementById('collectionsPage').style.display = 'none';
      document.getElementById('loginScreen').style.display = 'block';
    });

    document.getElementById('loginForm').addEventListener('submit', async (event) => {
      event.preventDefault();
      // Perform login validation here
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      try {
        const response = await fetch(isProduction ? apiUrl : localDataUrl, {
          headers: isProduction ? { Authorization: `token ${getToken()}` } : {},
        });
        const data = await response.json();
        const users = isProduction ? JSON.parse(data.files['data.json'].content).users : data.users;
        const user = users.find((user) => user.username === username && user.password === password);
        if (user) {
          document.getElementById('loginScreen').style.display = 'none';
          if (user.type === 'admin') {
            document.getElementById('adminDashboard').style.display = 'block';
          } else if (user.type === 'manager') {
            document.getElementById('customersPage').style.display = 'block';
            document.getElementById('loansPage').style.display = 'none';
            document.getElementById('collectionsPage').style.display = 'none';
            fetchData();
          }
        } else {
          showToast('Invalid credentials!');
        }
      } catch (error) {
        console.error('Error fetching users:', error);
        showToast('Error during login. Please try again.');
      }
    });

    document.getElementById('customersPageButton').addEventListener('click', () => {
      document.getElementById('customersPage').style.display = 'block';
      document.getElementById('loansPage').style.display = 'none';
      document.getElementById('collectionsPage').style.display = 'none';
    });

    document.getElementById('loansPageButton').addEventListener('click', () => {
      document.getElementById('customersPage').style.display = 'none';
      document.getElementById('loansPage').style.display = 'block';
      document.getElementById('collectionsPage').style.display = 'none';
    });

    document.getElementById('collectionsPageButton').addEventListener('click', () => {
      document.getElementById('customersPage').style.display = 'none';
      document.getElementById('loansPage').style.display = 'none';
      document.getElementById('collectionsPage').style.display = 'block';
    });

    // Initially show login screen
    document.getElementById('customersPage').style.display = 'none';
    document.getElementById('loansPage').style.display = 'none';
    document.getElementById('collectionsPage').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'block';

    // Fetch initial data
    fetchData();
  </script>
</body>
</html>
