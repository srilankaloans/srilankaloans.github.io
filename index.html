<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Retail Loan Management</title>
  <link rel="stylesheet" href="styles.css">
  <script defer src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script type="module" src="config.js"></script>
</head>
<body>
  <div id="app">
    <header>
      <h1>Sri Lanka Loans</h1>
      <button id="menuToggle" class="menu-toggle" style="display: none;">&#9776;</button>
      <nav id="mainNav" style="display: none;">
        <button id="customersPageButton">Customers</button>
        <button id="loansPageButton">Loans</button>
        <button id="collectionsPageButton">Collections</button>
        <button id="logoutButton">Logout</button>
      </nav>
    </header>
    <main>
      <div id="loginScreen" style="display: none;">
        <h2>Login</h2>
        <form id="loginForm">
          <input type="text" id="username" placeholder="Username" required />
          <input type="password" id="password" placeholder="Password" required />
          <button type="submit">Login</button>
        </form>
      </div>
      <div id="customersPage" style="display: none;">
        <h2>Customers</h2>
        <form id="addCustomerForm">
          <h3>Add New Customer</h3>
          <input type="text" id="customerName" placeholder="Customer Name" required />
          <button type="submit">Add Customer</button>
        </form>
        <h3>Customer List</h3>
        <table class="responsive-table" id="customersTable">
          <thead>
            <tr>
              <th>Customer ID</th>
              <th>Customer Name</th>
            </tr>
          </thead>
          <tbody id="customersList">
            <!-- Example row -->
            <tr>
              <td data-label="Customer ID">CUST0001</td>
              <td data-label="Customer Name">John Doe</td>
            </tr>
            <!-- ...existing code... -->
          </tbody>
        </table>
      </div>
      <div id="loansPage" style="display: none;">
        <h2>Loans</h2>
        <form id="addLoanForm">
          <h3>Add New Loan</h3>
          <select id="customerDropdown" required></select>
          <input type="number" id="loanAmount" placeholder="Loan Amount" required />
          <input type="number" id="interestRate" placeholder="Interest Rate (%)" value="20" required />
          <input type="number" id="duration" placeholder="Duration (days)" value="30" required />
          <button type="submit">Add Loan</button>
        </form>
        <h3>Loan List</h3>
        <table class="responsive-table" id="loansTable">
          <thead>
            <tr>
              <th>Loan ID</th>
              <th>Customer ID</th>
              <th>Loan Amount</th>
              <th>Interest Rate</th>
              <th>Duration</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="loansList">
            <!-- Example row -->
            <tr>
              <td data-label="Loan ID">LOAN0001</td>
              <td data-label="Customer ID">CUST0001</td>
              <td data-label="Loan Amount">$1000</td>
              <td data-label="Interest Rate">5%</td>
              <td data-label="Duration">30 days</td>
              <td data-label="Status">Active</td>
            </tr>
            <!-- ...existing code... -->
          </tbody>
        </table>
      </div>
      <div id="collectionsPage" style="display: none;">
        <h2>Collections</h2>
        <table class="responsive-table" id="collectionTable">
          <thead>
            <tr>
              <th>Customer Name</th>
              <th>Loan ID</th>
              <th>Start Date</th>
              <th>Collected Amount</th>
              <th>Count</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="collectionSection">
            <!-- Example row -->
            <tr>
              <td data-label="Customer Name">John Doe</td>
              <td data-label="Loan ID">LOAN0001</td>
              <td data-label="Start Date">01/01/2023</td>
              <td data-label="Collected Amount">$500</td>
              <td data-label="Count">5</td>
              <td data-label="Action">
                <button>Collect</button>
              </td>
            </tr>
            <!-- ...existing code... -->
          </tbody>
        </table>
      </div>
      <div id="adminDashboard" style="display: none;">
        <h2>Admin Dashboard</h2>
        <!-- Admin specific content goes here -->
      </div>
    </main>
  </div>
  <div id="toaster" class="toaster"></div>
  <script type="module">
    import { config, getToken } from './config.js';

    const isProduction = window.location.hostname !== '127.0.0.1';
    const { gistId } = config;
    const apiUrl = `https://api.github.com/gists/${gistId}`;
    const localDataUrl = 'data.json';

    let appState = {
      customers: [],
      loans: [],
      collections: [],
      users: [], // Add users to the app state
    };

    function showToast(message) {
      const toaster = document.getElementById('toaster');
      toaster.textContent = message;
      toaster.className = "toaster show";
      setTimeout(() => { toaster.className = toaster.className.replace("show", ""); }, 3000);
    }

    async function fetchData() {
      try {
        const response = await fetch(isProduction ? apiUrl : localDataUrl, {
          headers: isProduction ? { Authorization: `token ${getToken()}` } : {},
        });
        const data = await response.json();
        appState = isProduction ? JSON.parse(data.files['data.json'].content) : data;
        populateCustomerDropdown();
        populateCustomersList();
        populateLoansList();
        populateCollectionSection();
      } catch (error) {
        console.error('Error fetching data:', error);
        showToast('Error fetching data. Please try again.');
      }
    }

    async function saveData() {
      try {
        const updatedContent = JSON.stringify(appState, null, 2);
        if (isProduction) {
          await fetch(apiUrl, {
            method: 'PATCH',
            headers: {
              Authorization: `token ${getToken()}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              files: {
                'data.json': {
                  content: updatedContent,
                },
              },
            }),
          });
        } else {
          // For local development, you might need to implement a local server to handle saving data
          console.log('Data to be saved locally:', updatedContent);
        }
        showToast('Data saved successfully!');
      } catch (error) {
        console.error('Error saving data:', error);
        showToast('Error saving data. Please try again.');
      }
    }

    function autoGenerateCustomerId() {
      const maxId = appState.customers.reduce((max, customer) => {
        const id = parseInt(customer.id.replace('CUST', ''), 10);
        return id > max ? id : max;
      }, 0);
      return `CUST${String(maxId + 1).padStart(4, '0')}`;
    }

    function autoGenerateLoanId() {
      const maxId = appState.loans.reduce((max, loan) => {
        const id = parseInt(loan.id.replace('LOAN', ''), 10);
        return id > max ? id : max;
      }, 0);
      return `LOAN${String(maxId + 1).padStart(4, '0')}`;
    }

    function populateCustomerDropdown() {
      const customerDropdown = document.getElementById('customerDropdown');
      customerDropdown.innerHTML = '<option value="">Select Customer</option>';
      appState.customers.forEach((customer) => {
        const option = document.createElement('option');
        option.value = customer.id;
        option.textContent = customer.name;
        customerDropdown.appendChild(option);
      });
    }

    function populateCustomersList() {
      const customersList = document.getElementById('customersList');
      customersList.innerHTML = '';
      appState.customers.forEach((customer) => {
        const customerRow = document.createElement('tr');
        customerRow.innerHTML = `
          <td data-label="Customer ID">${customer.id}</td>
          <td data-label="Customer Name">${customer.name}</td>
        `;
        customersList.appendChild(customerRow);
      });
    }

    function populateLoansList() {
      const loansList = document.getElementById('loansList');
      loansList.innerHTML = '';
      appState.loans.forEach((loan) => {
        const loanRow = document.createElement('tr');
        loanRow.innerHTML = `
          <td data-label="Loan ID">${loan.id}</td>
          <td data-label="Customer ID">${loan.customerId}</td>
          <td data-label="Loan Amount">${loan.loanAmount}</td>
          <td data-label="Interest Rate">${loan.interestRate}</td>
          <td data-label="Duration">${loan.duration}</td>
          <td data-label="Status">${loan.status}</td>
        `;
        loansList.appendChild(loanRow);
      });
    }

    function populateCollectionSection() {
      const collectionSection = document.getElementById('collectionSection');
      collectionSection.innerHTML = '';
      appState.loans.forEach((loan) => {
        const customer = appState.customers.find((c) => c.id === loan.customerId);
        const dailyAmount = loan.loanAmount / loan.duration;
        const dailyCollection = dailyAmount + (dailyAmount * loan.interestRate / 100);
        const collections = appState.collections.filter((collection) => collection.loanId === loan.id);
        const collectedAmount = collections.reduce((total, collection) => total + dailyCollection, 0);
        const isCollectDisabled = collections.length >= loan.duration;
        if (isCollectDisabled) {
          loan.status = 'completed';
        }
        const loanDiv = document.createElement('tr');
        loanDiv.innerHTML = `
          <td data-label="Customer Name">${customer ? customer.name : 'Unknown'}</td>
          <td data-label="Loan ID">${loan.id}</td>
          <td data-label="Start Date">${new Date(loan.startDate).toLocaleDateString()}</td>
          <td data-label="Collected Amount">${collectedAmount.toFixed(2)}</td>
          <td data-label="Count">${collections.length}</td>
          <td data-label="Action">
            <button onclick="handleCollect('${loan.id}')" ${isCollectDisabled ? 'class="completed-button" disabled' : ''}>
              ${isCollectDisabled ? 'Completed' : 'Collect'}
            </button>
          </td>
        `;
        collectionSection.appendChild(loanDiv);
      });
    }

    async function handleCollect(loanId) {
      const confirmed = confirm('Are you sure you want to collect for this loan?');
      if (confirmed) {
        const loan = appState.loans.find((l) => l.id === loanId);
        appState.collections.push({ loanId, date: new Date().toISOString() });
        await saveData();
        showToast(`Collection recorded for Loan ID: ${loanId}`);
        populateCollectionSection(); // Update the collection section
      }
    }

    // Make handleCollect globally accessible
    window.handleCollect = handleCollect;

    const addCustomerForm = document.getElementById('addCustomerForm');
    addCustomerForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const customerName = document.getElementById('customerName').value;
      const customerId = autoGenerateCustomerId();
      appState.customers.push({ id: customerId, name: customerName });
      await saveData();
      populateCustomerDropdown();
      populateCustomersList();
      showToast('Customer added successfully!');
    });

    const addLoanForm = document.getElementById('addLoanForm');
    addLoanForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const customerId = document.getElementById('customerDropdown').value;
      const loanAmount = parseFloat(document.getElementById('loanAmount').value);
      const interestRate = parseFloat(document.getElementById('interestRate').value) || 20;
      const duration = parseInt(document.getElementById('duration').value, 10) || 30;
      const loanId = autoGenerateLoanId();
      appState.loans.push({ id: loanId, customerId, loanAmount, interestRate, duration, startDate: new Date().toISOString(), status: 'active' });
      await saveData();
      populateLoansList();
      populateCollectionSection();
      showToast('Loan added successfully!');
    });

    function toggleMenu() {
      const mainNav = document.getElementById('mainNav');
      mainNav.style.display = mainNav.style.display === 'block' ? 'none' : 'block';
    }

    document.getElementById('menuToggle').addEventListener('click', toggleMenu);

    function hideMenu() {
      const mainNav = document.getElementById('mainNav');
      mainNav.style.display = 'none';
    }

    document.getElementById('customersPageButton').addEventListener('click', () => {
      document.getElementById('customersPage').style.display = 'block';
      document.getElementById('loansPage').style.display = 'none';
      document.getElementById('collectionsPage').style.display = 'none';
      hideMenu();
    });

    document.getElementById('loansPageButton').addEventListener('click', () => {
      document.getElementById('customersPage').style.display = 'none';
      document.getElementById('loansPage').style.display = 'block';
      document.getElementById('collectionsPage').style.display = 'none';
      hideMenu();
    });

    document.getElementById('collectionsPageButton').addEventListener('click', () => {
      document.getElementById('customersPage').style.display = 'none';
      document.getElementById('loansPage').style.display = 'none';
      document.getElementById('collectionsPage').style.display = 'block';
      hideMenu();
    });

    document.getElementById('logoutButton').addEventListener('click', () => {
      // Clear app state and show login screen
      appState = {
        customers: [],
        loans: [],
        collections: [],
        users: appState.users, // Preserve users
      };
      showToast('You have been logged out.');
      document.getElementById('mainNav').style.display = 'none';
      document.getElementById('menuToggle').style.display = 'none';
      document.getElementById('customersPage').style.display = 'none';
      document.getElementById('loansPage').style.display = 'none';
      document.getElementById('collectionsPage').style.display = 'none';
      document.getElementById('loginScreen').style.display = 'block';
    });

    document.getElementById('loginForm').addEventListener('submit', async (event) => {
      event.preventDefault();
      // Perform login validation here
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      try {
        const response = await fetch(isProduction ? apiUrl : localDataUrl, {
          headers: isProduction ? { Authorization: `token ${getToken()}` } : {},
        });
        const data = await response.json();
        const users = isProduction ? JSON.parse(data.files['data.json'].content).users : data.users;
        const user = users.find((user) => user.username === username && user.password === password);
        if (user) {
          document.getElementById('loginScreen').style.display = 'none';
          document.getElementById('mainNav').style.display = 'none'; // Ensure menu is collapsed initially
          document.getElementById('menuToggle').style.display = 'block';
          if (user.type === 'admin') {
            document.getElementById('adminDashboard').style.display = 'block';
          } else if (user.type === 'manager') {
            document.getElementById('customersPage').style.display = 'block';
            document.getElementById('loansPage').style.display = 'none';
            document.getElementById('collectionsPage').style.display = 'none';
            fetchData();
          }
        } else {
          showToast('Invalid credentials!');
        }
      } catch (error) {
        console.error('Error fetching users:', error);
        showToast('Error during login. Please try again.');
      }
    });

    // Initially show login screen
    document.getElementById('mainNav').style.display = 'none';
    document.getElementById('menuToggle').style.display = 'none';
    document.getElementById('customersPage').style.display = 'none';
    document.getElementById('loansPage').style.display = 'none';
    document.getElementById('collectionsPage').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'block';

    // Fetch initial data
    fetchData();
  </script>
</body>
</html>
